<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 3.0//EN">
<!--Converted with LaTeX2HTML 96.1-h (September 30, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>5 Technical information</TITLE>
<META NAME="description" CONTENT="5 Technical information">
<META NAME="keywords" CONTENT="sidplay">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
</HEAD>
<BODY LANG="EN" BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#0030E0" VLINK="#001870">
 <A NAME="tex2html126" HREF="node7.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="./next_motif.gif"></A> <A NAME="tex2html124" HREF="sidplay.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="./up_motif.gif"></A> <A NAME="tex2html118" HREF="node5.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="./previous_motif.gif"></A> <A NAME="tex2html128" HREF="node1.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="./contents_motif.gif"></A>  <BR>
<B> Next:</B> <A NAME="tex2html127" HREF="node7.html">6 Ripping sidtunes</A>
<B>Up:</B> <A NAME="tex2html125" HREF="http://www.geocities.com/SiliconValley/Lakes/5147/index.html">SIDPLAY Home Page</A>
<B> Previous:</B> <A NAME="tex2html119" HREF="node5.html">4 Forcing a tune </A>
<BR> <P>
<H1><A NAME="SECTION00600000000000000000">5 Technical information</A></H1>
<P>
<H1><A NAME="SECTION00610000000000000000">5.1 Emulator Engine</A></H1>
<P>
<B>MOS-6502/6510 Micro Processor Unit (MPU) interpreter:</B>
<UL>
<LI> all valid machine code instructions
<LI> all illegal machine code instructions (parts 1-3)
<LI> relevant parts of RAM, ROM and I/O memory bank switching like a real C64
<LI> optional partial bank-switching mode (``Transparent ROM'')
<LI> optional 64 kB plain memory mode (``PlaySID environment'')
<LI> simulating CIA-6526 1 Timer-A directed interrupt handler calls
<LI> running at either PAL or NTSC clock speed
</UL>
<P>
<B>MOS-6581 Sound Interface Device (SID) emulator:</B>
<UL>
<LI> realtime dynamic ADSR volume envelope emulation including master volume
<LI> realtime wavelength-based waveform processing with partially precalculated
sample data at either 8-bit or 16-bit precision
<LI> correct SID noise emulation (<em>not</em> just white-noise)
<LI> full emulation of carrier-modulator ring modulation
<LI> full and correct emulation of hard synchronization
<LI> full range and accurate emulation of pulse width modulation
<LI> filter emulation (partially adjustable)
<LI> combined waveforms
<LI> extra MOS-8580 combined waveforms
<LI> C64-samples via PlaySID's extended SID registers
<LI> second set of PlaySID's extended SID registers for extra C64-sample channel
<LI> none of the emulated features is 100%
</UL>
<P>
<B>PlaySID (Amiga) compatibility:</B>
<UL>
<LI> compatible to PlaySID's one-file format v1 and v2
<LI> full compatible to PlaySID's Amiga Workbench tooltype info file format
<LI> compatible to PlaySID's way of loading/initializing sidtunes
<LI> optional PlaySID-like 64 kB plain memory mode (``PlaySID environment'')
<LI> compatible to PlaySID's Extended SID Registers
<LI> supporting PowerPacker ``PP20''-decompression (all efficiencies)
<LI> supporting SIDSONG flag for encapsulated mono Sidplayer songs
</UL>
<P>
<B>Some extra features:</B>
<UL>
<LI> flexible software mixer, capable of voice-mute, panning and surround
<LI> optional stereo and quality stereo mixing modes
<LI> optional stereo auto-panning mode
<LI> variable fast forward replay
<LI> file conversion functions
<LI> support for C64 Sidplayer <TT>.MUS</TT> files
<LI> ability to redirect the output to a <TT>.WAV</TT>/<TT>.AU</TT> file
<LI> overhead due to click fixes and special code that bypasses
sound hardware limits
</UL><H1><A NAME="SECTION00620000000000000000">5.2 Sidtune file formats</A></H1>
 <A NAME="fileformats">&#160;</A>
<H2><A NAME="SECTION00621000000000000000">5.2.1 Music data files</A></H2>
<P>
The data files used by SIDPLAY contain binary C64 data and music player machine code. Both, the
programmer on the C64 and this emulator need information on how to access the code inside the
binary file. That means, information like the memory location to load the file to, the number of
tunes, the starting address of the executable code and its subroutines. This specific information
has to be delivered in either a separate file - which is often called <B>info file</B> - or in
form of a header in the single binary data file. A standalone C64 data file without a header or
without a corresponding info file is considered invalid.
<P>
It is recommended that you get accustomed to one-file sidtunes with the <B><TT>*.sid</B></TT> extension.
For raw C64 binary files the extension <B><TT>.c64</B></TT> or <B><TT>.prg</B></TT> is
preferred in order to be able to assign a <B><TT>.sid</B></TT> extension to the
additional info file.
<P>
File format detection is done by examining the file contents rather than the file name
extension. Raw C64 binary files can't be detected. SIDPLAY can be set up to look for files with or
without any imaginable file name extension.
<P>
Supported and merely used file formats are:
<UL>
<LI> PlaySID single-file-format (widely known as <B><TT>PSID</B></TT>)
<LI> PlaySID info-file-format (Raw C64 binary file plus Amiga Workbench icon tooltype file <B><TT>.INFO</B></TT>)
<LI> SIDPLAY info-file-format (Raw C64 binary file plus SIDPLAY ASCII text info file, previously <B><TT>.SID</B></TT>)
<LI> C64 Sidplayer format (<B><TT>.MUS</B></TT>)
</UL>
<P>
Raw data or <B><TT>PSID</B></TT> files have appeared as <B><TT>*.data</B></TT>, <B><TT>*.psid</B></TT> or
<B><TT>psid.*</B></TT>. Additional icon info files have appeared as <B><TT>
*.info</B></TT>, ASCII info files as <B><TT>*.sid</B></TT>. Although obsolete, the formats with multiple files
are still used. The SIDPLAY file format is mainly used as a way to edit the sidtune information.
You can convert sidtunes from multiple files to the single file <B><TT>PSID</B></TT> format.
<P>
By default, but depending on the particular player front end, SIDPLAY searches
your directory for the following possible file name extensions and tries to
match a pair of files if the specified file is not in one-file format. This
list may change at any time:
<UL>
<LI> none
<LI> <TT>*.sid</TT>
<LI> <TT>*.dat</TT>
<LI> <TT>*.inf</TT>
<LI> <TT>*.DAT</TT>
<LI> <TT>*.SID</TT>
<LI> <TT>*.INF</TT>
<LI> <TT>*.c64</TT>
<LI> <TT>*.prg</TT>
<LI> <TT>*.C64</TT>
<LI> <TT>*.PRG</TT>
<LI> <TT>*.info</TT>
<LI> <TT>*.INFO</TT>
<LI> <TT>*.data</TT>
<LI> <TT>*.DATA</TT>
</UL><H2><A NAME="SECTION00622000000000000000">5.2.2 DAT files</A></H2>
<P>
The <B><TT>.DAT</B></TT> file name extension has been introduced with the early versions of SIDPLAY/DOS.
It has never been used to specify a file format. Its main use has been in assigning a unique file
name extension to any sidtune file, but especially raw C64 data files, and allowing to use
<B><TT>.SID</B></TT> for additional info files.
<P>
<H2><A NAME="SECTION00623000000000000000">5.2.3 INFO files</A></H2>
<P>
These are <em>Amiga Workbench</em> tooltype icons containing binary graphics data and ASCII text
information strings. They have been used by PlaySID and are supported by SIDPLAY. Their file name
extension normally is <B><TT>.info</B></TT> or <B><TT>.INF</B></TT>. This is a <em>two-file format</em>. A separate
C64 binary data file is required. On Amiga the corresponding C64 data files usually haven't had
filename extensions. However, they might have been renamed on other systems.
<P>
<H2><A NAME="SECTION00624000000000000000">5.2.4 SIDPLAY info files</A></H2>
<P>
These are plain ASCII text files which have been introduced by the earlier versions of SIDPLAY/DOS.
They are used to be able to alter the information inside with a normal ASCII text editor.
They can be converted to a single file that contains a binary header. This is a <em>two-file
format</em>. A separate C64 binary data file is required. Notice that each pair of files usually has
the old DOS-naming of <B><TT>.SID</B></TT> for the info file and <B><TT>.DAT</B></TT> for the C64 data file.
<P>
The SIDPLAY info file is derived from the information inside the PlaySID one-file format.
It is structured like this:
<P>
<PRE>    SIDPLAY INFOFILE
    ADDRESS=&lt;loadAddress&gt;,&lt;initAddress&gt;,&lt;playAddress&gt;
    SONGS=&lt;total&gt;[,&lt;start&gt;]
    SPEED=&lt;hexValue&gt;
    NAME=&lt;name of music/tune&gt;
    AUTHOR=&lt;name of author/composer&gt;
    COPYRIGHT=&lt;year/name of copyright owner/company&gt;
    SIDSONG=&lt;YES|NO&gt;</PRE>
<P>
The first line of the text containing ``SIDPLAY INFOFILE'' is only used to identify the type of file.
<P>
<PRE>    ADDRESS=&lt;loadAddress&gt;,&lt;initAddress&gt;,&lt;playAddress&gt;</PRE>
<P>
Each specified address is a 16-bit effective C64 memory location in case insensitive hexa-decimal
notation without a prefix, e.g. <B><TT>C000</B></TT> or <B><TT>E012</B></TT>, but neither <TT>$FCE2</TT> nor
<TT>0xFCE2</TT>. Preceding zeroes are ignored.
<P>
<TT>&lt;loadAddress&gt;</TT> is the C64 memory location where to put the C64 data. <TT>0</TT> means,
the data is in original C64 format, i.e. the first two bytes contain the little-endian load address
(low byte, high byte). Please don't explicitly specify the load address unless required for sure.
If the load address is explicitly specified, some sidtune converters and utilities conjecture that
the C64 data lacks its load address. Hence they move it in front of the C64 data. This would create
two redundant bytes if the C64 data already had a load address in the first two bytes. Additionally,
those extra bytes in the beginning can confuse disassemblers.
<P>
<TT>&lt;initAddress&gt;</TT> is the start address of the machine code subroutine that initializes a song by
accepting the contents of the 8-bit 6510 Accumulator as the song number parameter. <TT>0</TT> means,
the address is equal to the effective load address.
<P>
<TT>&lt;playAddress&gt;</TT> is the start address of the machine code subroutine that can be called frequently
to produce a continuous sound. <TT>0</TT> means, the initialization subroutine is expected to install
an interrupt handler, which then calls the music player. If so, the value in the bank-select register
<TT>$01</TT> determines whether the IRQ vector <TT>$0314/$0315</TT> (Kernal-ROM on) or the IRQ
vector <TT>$FFFE/$FFFF</TT> (Kernal-ROM off) is to be used.
<P>
<PRE>    SONGS=&lt;total&gt;,[&lt;start&gt;]</PRE>
<P>
<TT>&lt;total&gt;</TT> is the decimal number of songs (or sound effects) that can be initialized by calling
the init address. The minimum is <TT>1</TT>.
<P>
<TT>&lt;start&gt;</TT> is the decimal number of the song to be played by default. This value is meant as a
proposal and is optional. It has a default of <TT>1</TT>. It often specifies the first song you
would hear upon starting the program is has been taken from.
<P>
<PRE>    SPEED=&lt;value&gt;</PRE>
<P>
<TT>&lt;value&gt;</TT> is a value in case insensitive hexa-decimal notation without a prefix. Preceding
zeroes are ignored. The value contains information about the speed of each song. For each song a bit
is reserved, bit 0 for song 1, bit 1 for song 2, and so on. A bit set to <TT>0</TT> means, the music
player subroutine is called at 50 Hz. A bit set to <TT>1</TT> means, the real speed is indicated by the
CIA 1 Timer A <TT>$DC04/05</TT>, which defaults to 60 Hz. To not break compatibility to the PlaySID
formats, use a maximum of 32 bits, which is equal to 32 songs. Due to a bug in PlaySID, the PSID
format can only handle up to 8 songs correctly. On the contrary, the SIDPLAY info format is
extended to 256 bits, which is equal to 256 songs.
Examples: <TT>SPEED=0</TT> replays every song at 50 Hz speed. <TT>SPEED=1F</TT> replays songs 1-5 at 60 Hz
speed, all other songs at 50 Hz speed.
<P>
<PRE>    NAME=&lt;name of music/tune&gt;
    AUTHOR=&lt;name of author/composer&gt;
    COPYRIGHT=&lt;year/name of copyright owner/company&gt;</PRE>
<P>
These three fields are all plain ASCII text strings. There are limited to a maximum of 80 characters
each. To not break compatibility to the PlaySID formats, use a maximum of 31 characters.
<P>
<PRE>    SIDSONG=&lt;YES|NO&gt;</PRE>
<P>
is used to indicate that the corresponding C64 data file is in <em>(Enhanced) Sidplayer</em> file
format. This field is optional and defaults to <TT>NO</TT>.
<P>
An example file <TT>``EXAMPLE.SID''</TT> may look like this:
<P>
<PRE>    SIDPLAY INFOFILE
    ADDRESS=2AF0,3002,300C
    SONGS=3,2
    SPEED=0
    NAME=Example
    AUTHOR=Example
    COPYRIGHT=199? (c) Example
    SIDSONG=NO</PRE>
<P>
<H2><A NAME="SECTION00625000000000000000">5.2.5 The PSID file header</A></H2>
<P>
You can display any file with a normal ASCII/HEX editor. If the first four characters (bytes)
contain the word <B><TT>PSID</B></TT>, and if close to the beginning there are ASCII text strings
containing readable author and copyright information, you can almost be sure that it is in
PlaySID v2.2+ (Amiga) <em>one-file format</em>. This format is supported by SIDPLAY.
<P>
The detailed structure of the PSID header looks like the following. Header offsets are in
hexa-decimal notation. Other integer values are decimal unless explicitly marked otherwise.
Because of the Amiga hardware, any stored integer values are in big-endian format:
<P>
<PRE>+00    ``PSID''</PRE>
This is a four byte long ASCII character string containing the value 0x50534944.
<P>
<PRE>+04    WORD version</PRE>
Available version number can either be 0001 or 0002. Headers of version 2 provide additional
fields.
<P>
<PRE>+06    WORD dataOffset</PRE>
This is the offset from the start of the file to the C64 binary data area. Because of the fixed
size of the header, this is either 0x0076 for version 1 and 0x007C for version 2. Whether the value
in this field might also be the address of the used Amiga timer interrupt handler is unconfirmed.
Although interrupt level 7 really is at address 0x0000007C, the other value would be invalid.
The playsid.library doesn't recognize PSID files with other data offets.
<P>
<PRE>+08    WORD loadAddr</PRE>
The C64 memory location where to put the C64 data. <TT>0</TT> means,
the data is in original C64 format, i.e. the first two bytes contain the little-endian load address
(low byte, high byte). Please don't explicitly specify the load address unless required for sure.
If the load address is explicitly specified, some sidtune converters and utilities conjecture that
the C64 data lacks its load address. Hence they move it in front of the C64 data. This would create
two redundant bytes if the C64 data already had a load address in the first two bytes. Additionally,
those extra bytes in the beginning can confuse disassemblers.
<P>
<PRE>+0A    WORD initAddr</PRE>
The start address of the machine code subroutine that initializes a song, accepting the
contents of the 8-bit 6510 Accumulator as the song number parameter. <TT>0</TT> means, the address is
equal to the effective load address.
<P>
<PRE>+0C    WORD playAddr</PRE>
The start address of the machine code subroutine that can be called frequently to produce a
continuous sound. <TT>0</TT> means, the initialization subroutine is supposed to install an interrupt
handler, which then calls the music player at some place.
<P>
<PRE>+0E    WORD songs</PRE>
The number of songs (or sound effects) that can be initialized by calling the init address.
The minimum is 1. The maximum is 256.
<P>
<PRE>+10    WORD startSong</PRE>
The song number to be played by default. This value is meant as a proposal and is optional.
It often specifies the first song you would hear upon starting the program is has been taken from.
It has a default of 1.
<P>
<PRE>+12    LONGWORD speed</PRE>
This field does not work like it was intended. The PlaySID authors wrote:
<BLOCKQUOTE> speeddata contains info about playspeed. For each tune a bit is
 reserved, bit 0 for tune nr 1 and so on. A 0 bit means vertical sync 
 (50Hz PAL or 60Hz NTSC) and a 1 bit means 60 Hz or the time set in 
 <TT>$DC04/05</TT>. Default value is 0 for all bits.
</BLOCKQUOTE>
Unfortunately, PlaySID's behaviour upon evaluating this field is different. Only the
least significant byte does work<A NAME="tex2html4" HREF="footnode.html#240"><IMG  ALIGN=BOTTOM ALT="gif" SRC="./foot_motif.gif"></A>.
When starting to count from 0, all songs above or equal to number 8 are always set to speed 0,
i.e. 50 Hz PAL. Since 32-bits are used, the technique would work only for a maximum of 32 songs
anyway.
<P>
<PRE>+16    ``&lt;name&gt;''
+36    ``&lt;author&gt;''
+56    ``&lt;copyright&gt;''</PRE>
These are 32 byte long zero terminated ASCII character strings. Upon evaluating the header, a zero
byte will always be put into the last byte of each string. So the maximum number of available free
characters is 31.
<P>
<PRE>+76    &lt;data&gt;</PRE>
Version 1 of the PSID header is complete at this point. The binary C64 data starts here.
<P>
<H3><A NAME="SECTION00625100000000000000">The PSID file header v2</A></H3>
<P>
Version 2 of the header provides additional fields. These are undocumented, but most likely
rarely used.
<P>
<PRE>+76    WORD flags</PRE>
If bit 0 of this field is set, the appended binary data is in Compute!'s Sidplayer MUS format,
and does not contain a built-in music player. An external player machine code must be merged to
replay such a sidtune. This field almost ever contains a zero.
<P>
<PRE>+78    LONGWORD reserved</PRE>
This is undocumented.
<P>
<PRE>+7C    &lt;data&gt;</PRE>
Version 2 of the PSID header ends here. This offset is the start of the binary C64 data.
<P>
<H1><A NAME="SECTION00630000000000000000">5.3 Extended SID registers</A></H1>
<P>
This is the original description of the enhanced SID registers, which
were introduced in the PlaySID documentation.
<P>
<PRE>*********************
* NEW SID REGISTERS *
*********************

	ADDRESS	VALUE	FUNCTION			USAGE

	D41D	00-FC	Nr of tones-1			Galway-Noise (START)
		FD	Stop Sampling			Sample (STOP)
		FC	Start Sampling with 1/4		Sample (START)
			volume
		FE	Start Sampling with 1/2		Sample (START)
			volume
		FF	Start Sampling			Sample (START)
			ex. 4-bit sample -&gt; FF
			    3-bit sample (one extra LSR)
			    -&gt; FE etc.
			note. only write to this reg
			      after setting the other
			      regs to proper values.

	D41E	00-FF	ToneData address lowbyte	Galway-Noise
	D41F	00-FF	ToneData address highbyte	Galway-Noise
	D41E	00-FF	SampleData address low		Sample
	D41F	00-FF	SampleData address high		Sample

	D43D	00-FF	Tonelength (in samples)		Galway-Noise
	D43E	00-0F	Volume of Noise			Galway-Noise
	D43D	00-FF	SampleData end addr. low	Sample
	D43E	00-FF	SampleData end addr. high	Sample

	D43F	00-FF	Period for each value of	Galway-Noise
			ToneData (in C64-cycles)
		00-FE	Nr times of Repeat		Sample
		FF	Continious sample		Sample

	D45D	00-FF	Period for value 0 of		Galway-Noise
			ToneData (in C64-cycles)
		00-FF	Period for samples lowbyte	Sample
	D45E	00-FF	Period for samples highbyte	Sample
			(in C64-cycles)
			ex. the period is usually the 
			    value of the timer on 6526
			    ($DD04,05 etc.) which handles
			    the NMI-irq used

	D45F	00,01	Nr of bytes to add after	Sample
		02,04	Reading one nibble (4 bits)
		08...	(i.e. Octave) ,usually 00
			ex. xx xx xx xx ... -&gt; 00
			    x_ x_ x_ x_ ... -&gt; 01
			    x_ __ x_ __ ... -&gt; 02 etc.

	D47D	00	Sampleorder: Lownibble		Sample
			,Highnibble (the most used)
		01	Sampleorder: Highnibble		Sample
			,Lownibble
			ex. (12 34 -&gt; 1 2 3 4) -&gt; 01
			    (12 34 -&gt; 2 1 4 3) -&gt; 00

	D47E	00-FF	SampleData repeataddress low	Sample
	D47F	00-FF	SampleData repeataddress high	Sample


* EXAMPLES *
; *** MARTIN GALWAY *** *** NOISE ***
; 6502 Routine:
; Loop of Y=5 to 0 step -1
; Loop of X=19 to 0 step -1
; Read $B64E,Y in A
; Wait A*73 cycles
; Wait 22 cycles
; Add 7 to volume
; End Loop X
; End Loop Y
; END
;
; Replacement with:
; D43D=$19
; D41E=$4E, D41F=$B6
; D43F=$73
; D45D=$22
; D43E=$07
; D41D=$05
;
; *** MARTIN GALWAY *** *** SAMPLE ***
; 6502 Routine:
; Loop of Y=0 to 100 step 1
; Read $B64E,Y in A
; Write Lownibble of A in Volumereg
; Wait 74 cycles
; Write Highnibble of A in Volumereg
; Wait 74 cycles
; End Loop Y
; Do it one more time
; END
;
; Replacement with:
; D41E=$4E, D41F=$B6
; D43D=$4E, D43E=$B7
; D45D=$74, D45E=$00
; D45F=$00
; D47D=$00
; D43F=$01
; D47E=$4E, D47F=$B6
; D41D=$FF
;
;
; *** ORDINARY SAMPLE ***
; 6502 NMI-irq Routine:
; Checks if all is played ($FC,$FD = $FE,$FF ?)
; Loads next byte with LDA ($FC),Y  (Y = 0) ,if so required
; Shift outs the highnibble , if so required
; Stores this value in $D418
; Exits (RTI)
;
; Replacement with:
; Locate the routine which initalizes the values $FC-$FF and 
; which starts the NMI-irq (Probably with LDA #$81,STA $DD0D,
; LDA #$xx,STA $DD04,LDA #$yy,STA DD05 etc.)
; Do instead this,
; D41E,1F = value of adress $FC,FD
; D43D,3E = value of adress $FE,FF
; D43F = 00 , D45F = 00
; D47D = 00 or 01
; D45D,5E = value of address $DD04,05
; D41D = FF
;</PRE>
<P>
<HR><A NAME="tex2html126" HREF="node7.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="./next_motif.gif"></A> <A NAME="tex2html124" HREF="sidplay.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="./up_motif.gif"></A> <A NAME="tex2html118" HREF="node5.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="./previous_motif.gif"></A> <A NAME="tex2html128" HREF="node1.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="./contents_motif.gif"></A>  <BR>
<B> Next:</B> <A NAME="tex2html127" HREF="node7.html">6 Ripping sidtunes</A>
<B>Up:</B> <A NAME="tex2html125" HREF="http://www.geocities.com/SiliconValley/Lakes/5147/index.html">SIDPLAY Home Page</A>
<B> Previous:</B> <A NAME="tex2html119" HREF="node5.html">4 Forcing a tune </A>
</BODY>
</HTML>
